<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PIS-1274 即時示波器 + 音量條 (Firebase Realtime DB)</title>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<!-- Firebase (App + Database) - modular SDK -->
<script type="module">
  // Firebase modular imports (ES module)
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { getDatabase, ref, onChildAdded, onValue } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

  // ----------------------------
  // TODO：把下面 firebaseConfig 改成你自己專案的設定
  // ----------------------------
  const firebaseConfig = {
    apiKey: "AIzaSyAQWG323BRncrLBJ6RKqnLuJs2QLp0t0p4",
    authDomain: "esp32-b359f.firebaseapp.com",
    databaseURL: "https://esp32-b359f-default-rtdb.firebaseio.com", // <- 請改成你的 Realtime DB URL
    projectId: "esp32-b359f",
    storageBucket: "esp32-b359f.firebasestorage.app",
    messagingSenderId: "967156924614",
    appId: "1:967156924614:web:294adc2366da343c0317c7",
    measurementId: "G-KE13GPQM9Q"
  };

  // 初始化 Firebase App 與 Realtime Database
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // 把 db 與部分 function 暴露到 window，讓下面非 module 碼也能使用（簡單處理）
  window._FB = { db, ref, onChildAdded, onValue };
</script>

<style>
  body { font-family: system-ui, -apple-system, "Microsoft JhengHei", "Noto Sans TC", sans-serif; margin: 12px; background:#f6f8fb; color:#222; }
  header { display:flex; gap:12px; align-items:center; margin-bottom:10px; }
  .btn { padding:8px 12px; border-radius:8px; border:1px solid #ccc; background:white; cursor:pointer; }
  .btn.primary { background:#2563eb; color:white; border-color:#1e40af; }
  .controls { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  #main { display:grid; grid-template-columns: 1fr 220px; gap:12px; align-items:start; }
  .card { background:white; border-radius:10px; padding:10px; box-shadow: 0 6px 18px rgba(20,20,40,0.06); }
  #chartWrap { height:360px; }
  #meter { width: 100%; height: 200px; display:flex; align-items:center; justify-content:center; }
  #volBar { width: 60px; height: 160px; background:#eee; border-radius:8px; position:relative; overflow:hidden; }
  #volFill { position:absolute; bottom:0; left:0; width:100%; height:0%; background:linear-gradient(180deg,#34d399,#60a5fa); display:flex; align-items:flex-end; justify-content:center; }
  #volText { margin-top:10px; font-weight:600; }
  .small { font-size:13px; color:#555; }
  footer { margin-top:12px; font-size:12px; color:#666; }
  #status { font-weight:600; color:#0b5; }
</style>
</head>
<body>

<header>
  <h2 style="margin:0">PIS-1274 即時示波器 + 音量條</h2>
  <div style="margin-left:8px" class="small">改為 Firebase Realtime Database（ESP32 → 網路 → DB；瀏覽器直接監聽 DB）</div>
</header>

<!-- controls 保留（移除 Serial 相關按鈕） -->
<div class="controls card" style="display:flex; gap:8px; align-items:center;">
  <label class="small">Samples:
    <input id="samples" type="number" min="50" max="5000" value="600" style="width:80px;padding:6px;border-radius:6px;border:1px solid #ccc" />
  </label>
  <button id="pauseBtn" class="btn">Pause</button>
  <button id="exportBtn" class="btn">Export CSV</button>
  <div style="margin-left:auto" class="small">狀態：<span id="status">未連線 DB</span></div>
</div>

<section id="main">
  <div class="card">
    <div id="chartWrap">
      <canvas id="waveChart"></canvas>
    </div>
    <div style="display:flex; gap:12px; margin-top:8px; align-items:center;">
      <div class="small">RMS window: <input id="rmsWindow" type="number" min="1" max="500" value="30" style="width:70px;padding:4px;border-radius:6px;border:1px solid #ccc" /></div>
      <div class="small">Threshold (V): <input id="threshold" type="number" step="0.01" value="1.0" style="width:70px;padding:4px;border-radius:6px;border:1px solid #ccc" /></div>
      <div class="small" id="liveValues">最新：0.00 V  |  RMS：0.00 V</div>
    </div>
  </div>

  <div class="card" style="display:flex; flex-direction:column; gap:12px; align-items:center;">
    <div style="font-weight:700">音量條 (RMS)</div>
    <div id="meter">
      <div id="volBar">
        <div id="volFill"></div>
      </div>
    </div>
    <div id="volText">0.00 V</div>
    <div style="width:100%;"><div class="small">說明：ESP32 請透過 HTTP POST 推資料到 Realtime DB 的 esp32/stream 路徑（每筆一個數值）</div></div>
  </div>
</section>

<footer>
  <div>如何使用：<br>
  1) 在 Firebase Console 建立 Realtime Database，修改規則（下方有範例）以便測試；<br>
  2) 修改上方 firebaseConfig.databaseURL；3) 上傳 ESP32 程式（範例在下方）；4) 開啟本頁，會自動監聽 DB 的新資料並即時顯示。</div>
</footer>

<script>
(async () => {
  // UI elements
  const statusEl = document.getElementById('status');
  const pauseBtn = document.getElementById('pauseBtn');
  const samplesInput = document.getElementById('samples');
  const rmsWindowInput = document.getElementById('rmsWindow');
  const thresholdInput = document.getElementById('threshold');
  const liveValues = document.getElementById('liveValues');
  const exportBtn = document.getElementById('exportBtn');

  const volFill = document.getElementById('volFill');
  const volText = document.getElementById('volText');

  let paused = false;

  // Data buffer
  let maxSamples = parseInt(samplesInput.value, 10);
  let buffer = new Array(maxSamples).fill(0);
  let timestamps = new Array(maxSamples).fill(0);

  // Chart.js setup
  const ctx = document.getElementById('waveChart').getContext('2d');
  const chartData = {
    labels: Array.from({length:buffer.length}, (_,i)=>i),
    datasets: [{
      label: 'Voltage (V)',
      data: buffer.slice(),
      borderWidth: 1,
      pointRadius: 0,
      borderColor: '#2563eb',
      tension: 0.15,
    }]
  };
  const waveChart = new Chart(ctx, {
    type: 'line',
    data: chartData,
    options: {
      animation: false,
      responsive: true,
      maintainAspectRatio: false,
      elements: {line: {borderJoinStyle: 'round'}},
      scales: {
        x: { display: false },
        y: { min: 0, max: 3.3 }
      },
      plugins: {
        legend: { display: false }
      }
    }
  });

  function resizeBuffers(newLen) {
    maxSamples = newLen;
    const oldBuf = buffer.slice();
    buffer = new Array(maxSamples).fill(0);
    timestamps = new Array(maxSamples).fill(0);
    // copy tail
    for (let i=0;i<Math.min(oldBuf.length, buffer.length); i++){
      buffer[buffer.length-1-i] = oldBuf[oldBuf.length-1-i];
    }
    waveChart.data.labels = Array.from({length:buffer.length}, (_,i)=>i);
    waveChart.data.datasets[0].data = buffer.slice();
    waveChart.update();
  }

  samplesInput.addEventListener('change', ()=> {
    let v = parseInt(samplesInput.value,10) || 600;
    if (v < 50) v = 50;
    if (v > 5000) v = 5000;
    samplesInput.value = v;
    resizeBuffers(v);
  });

  // RMS calculation over last N samples
  function computeRMS(window) {
    let sumSq = 0, count = 0;
    for (let i=buffer.length - 1; i>=0 && count < window; i--, count++){
      const v = buffer[i];
      sumSq += v*v;
    }
    if (count === 0) return 0;
    return Math.sqrt(sumSq / count);
  }

  // Update UI with a new sample (主要由 DB Listener 呼叫)
  function pushSample(v, ts = Date.now()){
    // shift & push
    buffer.shift();
    buffer.push(v);
    timestamps.shift();
    timestamps.push(ts);

    const rms = computeRMS(parseInt(rmsWindowInput.value,10) || 30);
    // update chart dataset
    waveChart.data.datasets[0].data = buffer.slice();
    // update meter
    const pct = Math.max(0, Math.min(1, rms / 3.3));
    volFill.style.height = (pct * 100) + '%';
    volText.textContent = rms.toFixed(3) + ' V';
    // live info
    liveValues.textContent = `最新：${v.toFixed(3)} V  |  RMS：${rms.toFixed(3)} V`;
    // threshold style (if above threshold, flash color)
    const thr = parseFloat(thresholdInput.value) || 1.0;
    if (rms >= thr) {
      volFill.style.background = 'linear-gradient(180deg,#fb7185,#ef4444)'; // red
      statusEl.textContent = 'Alert'; statusEl.style.color = '#c0262e';
    } else {
      volFill.style.background = 'linear-gradient(180deg,#34d399,#60a5fa)'; // green-blue
      statusEl.textContent = 'Listening'; statusEl.style.color = '#0b5';
    }
  }

  // Export current buffer to CSV
  exportBtn.addEventListener('click', () => {
    let csv = 'sample_index,voltage_V,timestamp\n';
    for (let i=0;i<buffer.length;i++){
      csv += `${i},${buffer[i]},${timestamps[i]}\n`;
    }
    const blob = new Blob([csv], {type:'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'sound_data.csv';
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  });

  // Pause
  pauseBtn.addEventListener('click', ()=> {
    paused = !paused;
    pauseBtn.textContent = paused ? 'Resume' : 'Pause';
  });

  // Helper parse float (defensive)
  function parseMaybeFloat(v) {
    if (typeof v === 'number') return v;
    const m = (''+v).match(/[-+]?[0-9]*\.?[0-9]+([eE][-+]?[0-9]+)?/);
    return m ? parseFloat(m[0]) : NaN;
  }

  // -------------------------------
  // Firebase DB Listener 部分（Realtime DB）
  // 我們會監聽 /esp32/stream 的 child_added（新筆資料）
  // -------------------------------
  function startDatabaseListener() {
    try {
      // 來自最上方 module 匯入，window._FB.db 已初始化
      const { db, ref, onChildAdded } = window._FB;
      const streamRef = ref(db, 'esp32/stream'); // 想要監聽的路徑
      // child_added 當有新子節點加入時會被觸發（適合 streaming）
      onChildAdded(streamRef, (snap) => {
        const val = snap.val();
        // 範例資料格式： { voltage: 0.523, ts: 169... }
        const voltage = parseMaybeFloat(val?.voltage ?? val);
        const ts = val?.ts ? Number(val.ts) : Date.now();
        if (!isNaN(voltage)) {
          if (!paused) pushSample(voltage, ts);
          // 可選：自動刪除舊資料或限制數量（避免 DB 無限增長）
        }
        // 每來一筆就更新 chart（Chart.js）
        waveChart.update('none');
      });

      // 可選：更新狀態顯示（檢查 DB 連線）
      statusEl.textContent = 'Listening'; statusEl.style.color = '#0b5';
    } catch (e) {
      console.error('DB listener 啟動失敗', e);
      statusEl.textContent = 'DB 監聽失敗';
      statusEl.style.color = '#c0262e';
    }
  }

  // 初始化圖表畫面
  waveChart.update();

  // 啟動 DB 監聽
  startDatabaseListener();

  // 完成
})();
</script>
</body>
</html>
